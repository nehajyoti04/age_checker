<?php

//use Drupal\Core\Routing\RouteMatchInterface;
//use \Drupal\Core\Form\FormStateInterface;
//use Drupal\Core\State\State;
use Symfony\Component\HttpFoundation;
//use Symfony\Component\HttpFoundation\Request;

use Drupal\Core\Datetime\Date;
//use Drupal\Core\Form\ConfigFormBase;
use Drupal\Component\Serialization\Json;



/**
 * Implements hook_page_attachments().
 */
function age_checker_page_attachments(array &$attachments) {

//$attachments['#attached']['library'][] = 'js/age_checker';
  $attachments['#attached']['library'][] = 'age_checker/age_checker.admin';

  // $attachments['#attached']['library'][] = array('age_checker', 'admin');
  // $form['#attached']['library'][] = array('webform', 'admin');
}

/**
 * Get the country name for Age Gate.
 */
function age_checker_get_country_name() {
  // Get the country code.

  $country_code = age_checker_get_country_code();
  // Get the default country.
  $default_country =\Drupal::state()->get('age_checker_default_country');

  $countries = \Drupal::state()->get('age_checker_countries', '');

//  dpm("countries");
//  dpm($countries);exit;

  $countries = explode("\n", $countries);

  foreach ($countries as $country) {
    $country_array = explode('|', $country);
    if (trim($country_array[0]) == $country_code) {
      $country_name = $country_code;
      break;
    }
    else {
      $country_name = $default_country;
    }
  }
  return $country_name;
}

/**
 * Get the country code.
 */
function age_checker_get_country_code() {

$ip_address = Drupal::request()->getClientIp();
//  $x = \Drupal::state('age_checker_country_code_url');
//  dpm("x");
//  dpm($x);
  $x = 'http://geoip.nekudo.com/api/';
//  $url = \Drupal::state('age_checker_country_code_url') . $ip_address;
  $url = $x.$ip_address;
  $geoip_data = age_checker_get_geoip_data($url);

  if (is_array($geoip_data)) {
    $country_code = $geoip_data['country']['code'];
  }
  else {
    $country_code = \Drupal::state('age_checker_default_country');
  }

  return $country_code;
}

/**
 * Implements a function to get country name.
 */
function age_checker_get_geoip_data($url) {
  $json_data = FALSE;
  try {
    $response = \Drupal::httpClient()->get($url, array('headers' => array('Accept' => 'text/plain')));
    $data = (string) $response->getBody();
    $json_data = Json::decode($data);
    if (empty($json_data)) {
      return FALSE;
    }
  }
  catch (RequestException $e) {
    return FALSE;
  }
  return $json_data;
}